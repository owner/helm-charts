---
name: "Charts: Test (Reusable)"

on:
  workflow_call:
    inputs:
      charts:
        description: >
          Json encoded list of Helm charts to release. Defaults to releasing everything.
        default: "[]"
        required: true
        type: string

permissions:
  contents: read

jobs:
  build-matrix:
    name: Build charts/version matrix
    runs-on: ubuntu-24.04
    timeout-minutes: 10
    if: ${{ inputs.charts != '[]' && inputs.charts != '' }}
    outputs:
      matrix: ${{ steps.merge.outputs.matrix }}
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Build kubernetes version matrix
        id: build
        uses: ./.github/actions/build-k8s-k3s-version-matrix
        with:
          min_k8s_version: "1.28"
          github_token: ${{ github.token }}

      - name: Merge charts with versions
        id: merge
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        env:
          CHARTS_JSON: ${{ inputs.charts }}
          VERSIONS_JSON: ${{ steps.build.outputs.versions }}
        with:
          script: |
            const rawCharts = process.env.CHARTS_JSON;
            const rawVersions = process.env.VERSIONS_JSON;

            const charts = rawCharts && rawCharts !== 'null' ? JSON.parse(rawCharts) : [];
            const versions = rawVersions && rawVersions !== 'null' ? JSON.parse(rawVersions) : [];

            const matrix = charts.flatMap((chart) =>
              versions.map((version) => ({
                chart,
                k8s_version: version.k8s_version,
                k3s_tag: version.k3s_tag,
              }))
            );

            core.setOutput('matrix', JSON.stringify(matrix));
            console.log(JSON.stringify(matrix));

  install-chart:
    name: Install chart
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    needs:
      - build-matrix
    if: ${{ needs.build-matrix.outputs.matrix != '[]' && needs.build-matrix.outputs.matrix != '' }}
    strategy:
      matrix:
        include: ${{ fromJSON(needs.build-matrix.outputs.matrix) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Validate prerequisite folders
        working-directory: "charts/${{ matrix.chart }}"
        run: |
          CHART_TYPE=$(yq '.type // "application"' Chart.yaml)
          if [[ ("${CHART_TYPE}" == "library") && (! -d "test-chart") ]]; then
            echo "Library charts require a \"test-chart\" directory to run tests"
            exit 1
          fi

      - name: Install kubectl matching k8s version
        uses: yokawasa/action-setup-kube-tools@3e3886c11bfa25fe33f8eb90f59542dd151da442 # v0.13.1
        with:
          setup-tools: |
            kubectl
          kubectl: "${{ matrix.k8s_version }}"

      - name: Install Mise and required tools
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          cache_key: "mise-v1-{{file_hash}}"

      - name: Create a new k3s cluster
        env:
          GH_TOKEN: ${{ github.token }}
          K8S_VERSION: ${{ matrix.k8s_version }}
          K3S_IMAGE: docker.io/rancher/k3s
          K3S_TAG: ${{ matrix.k3s_tag }}
        run: |
          k3d cluster create --image "${K3S_IMAGE}:${K3S_TAG}"
          echo "::group::Waiting for cluster readiness"
          while ! kubectl get serviceaccount default >/dev/null; do sleep 1; done
          echo "::endgroup::"

      - name: Remove node taints
        run: |
          kubectl taint --all=true nodes node.cloudprovider.kubernetes.io/uninitialized- || true

      - name: Dereference JSON schema
        uses: bjw-s-labs/helm-charts-actions/dereference-json-schema@b840e92f9bb81d34ec7b1c2d396e2e8e2c0b0b91
        with:
          schemaFile: "charts/${{ matrix.chart }}/values.schema.json"
          outputFile: "charts/${{ matrix.chart }}/values.schema.json"
          allowFileNotFound: true

      - name: Always assume in-repo common library
        env:
          COMMON_LIBRARY_LOCATION: ${{ github.workspace }}/charts/library/common
        working-directory: charts/${{ matrix.chart }}
        run: |
          yq -i '. |= .dependencies |= map(select(.name == "common" and .repository == "https://bjw-s-labs.github.io/helm-charts").version = ">0.0.0-0")' Chart.yaml
          yq -i '. |= .dependencies |= map(select(.name == "common" and .repository == "https://bjw-s-labs.github.io/helm-charts").repository = "file://" + strenv(COMMON_LIBRARY_LOCATION))' Chart.yaml
          echo "::group::Modified Chart.yaml"
          cat Chart.yaml
          echo "::endgroup::"

      - name: Run chart-testing (install)
        working-directory: "charts/${{ matrix.chart }}"
        run: |
          if [ -d "test-chart" ]; then
            cd "test-chart"
          fi

          ct install --config "${GITHUB_WORKSPACE}/.ci/ct/ct.yaml" --charts .

  install_success:
    needs:
      - install-chart
    if: ${{ !cancelled() }}
    name: Install successful
    runs-on: ubuntu-latest
    steps:
      - name: Check matrix status
        if: >-
          ${{
              (inputs.chartsToTest != '' && inputs.chartsToTest != '[]') &&
              contains(needs.*.result, 'failure')
          }}
        run: exit 1

  unittest-chart:
    name: Unit-test chart
    runs-on: ubuntu-24.04
    timeout-minutes: 30
    if: ${{ inputs.charts != '[]' && inputs.charts != '' }}
    strategy:
      matrix:
        chart: ${{ fromJSON(inputs.charts) }}
      fail-fast: false
    steps:
      - name: Checkout
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8 # v6.0.1
        with:
          persist-credentials: false

      - name: Validate prerequisite folders
        working-directory: "charts/${{ matrix.chart }}"
        run: |
          CHART_TYPE=$(yq '.type // "application"' Chart.yaml)
          if [[ ("${CHART_TYPE}" == "library") && (! -d "test-chart") ]]; then
            echo "Library charts require a \"test-chart\" directory to run tests"
            exit 1
          fi

      - name: Install Mise and required tools
        uses: jdx/mise-action@146a28175021df8ca24f8ee1828cc2a60f980bd5 # v3.5.1
        with:
          cache_key: "mise-v1-{{file_hash}}"

      - name: Dereference JSON schema
        uses: bjw-s-labs/helm-charts-actions/dereference-json-schema@b840e92f9bb81d34ec7b1c2d396e2e8e2c0b0b91
        with:
          schemaFile: "charts/${{ matrix.chart }}/values.schema.json"
          outputFile: "charts/${{ matrix.chart }}/values.schema.json"
          allowFileNotFound: true

      - name: Run tests
        working-directory: "charts/${{ matrix.chart }}"
        env:
          MATRIX_CHART: ${{ matrix.chart }}
        run: |
          if [[ -d "test-chart" ]]; then
            cd "test-chart"
          fi

          if [[ ! -d "unittests" ]]; then
            echo "No unit tests found for chart ${MATRIX_CHART}"
            exit 0
          fi

          helm plugin install https://github.com/helm-unittest/helm-unittest.git --verify=false
          helm dep update
          helm unittest -f "unittests/**/*_test.yaml" . 2> >(grep -v 'found symbolic link' >&2)

  unittest_success:
    needs:
      - unittest-chart
    if: ${{ !cancelled() }}
    name: Unittest successful
    runs-on: ubuntu-latest
    steps:
      - name: Check matrix status
        if: >-
          ${{
              (inputs.chartsToTest != '' && inputs.chartsToTest != '[]') &&
              contains(needs.*.result, 'failure')
          }}
        run: exit 1
